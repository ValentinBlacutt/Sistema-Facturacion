@model IEnumerable<sistemaFacturacion.Models.Producto>

@{
    ViewData["Title"] = "Lista de Productos";
}

<div class="container mt-4">
    <h1 class="text-center mb-4 text-primary fw-bold">
        <i class="fas fa-boxes me-2"></i> Gestión de Productos
    </h1>

    <!-- Barra de búsqueda -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="input-group shadow-sm rounded-pill">
                <span class="input-group-text rounded-pill-start bg-light border-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control border-0 bg-light" placeholder="Buscar por nombre o código de barras..." autocomplete="off">
                <button class="btn btn-outline-secondary rounded-pill-end" type="button" id="scanButton" title="Escanear código de barras">
                    <i class="fas fa-barcode"></i>
                </button>
            </div>
            <div class="form-text text-end mt-1">
                <span id="resultCount"></span>
            </div>
            <div id="cameraContainer" class="mt-3 d-none">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Escaneador de código de barras</span>
                        <button type="button" class="btn-close" id="closeCamera"></button>
                    </div>
                    <div class="card-body text-center">
                        <div id="scanner"></div>
                        <div class="form-text">Enfoca el código de barras con la cámara</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p class="text-center mb-4">
        <a asp-action="Create" class="btn btn-primary btn-lg shadow-sm rounded-pill px-4 py-2">
            <i class="fas fa-plus-circle me-2"></i> Crear Nuevo Producto
        </a>
    </p>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered rounded-lg shadow-sm">
            <thead class="bg-primary text-white">
                <tr>
                    <th scope="col">
                        @Html.DisplayNameFor(model => model.Nombre)
                    </th>
                    <th scope="col">
                        @Html.DisplayNameFor(model => model.Precio)
                    </th>
                    <th scope="col">
                        @Html.DisplayNameFor(model => model.Stock)
                    </th>
                    <th scope="col" class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                @if (Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.Nombre)</td>
                            <td>@Html.DisplayFor(modelItem => item.Precio)</td>
                            <td>@Html.DisplayFor(modelItem => item.Stock)</td>
                            <td class="text-center">
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info rounded-pill me-1" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-secondary rounded-pill me-1" title="Detalles">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-outline-danger rounded-pill" title="Eliminar">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle me-2"></i> No se encontraron productos.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <!-- Incluir biblioteca para escanear códigos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const scanButton = document.getElementById('scanButton');
            const closeCamera = document.getElementById('closeCamera');
            const cameraContainer = document.getElementById('cameraContainer');
            const productTableBody = document.getElementById('productTableBody');
            const resultCount = document.getElementById('resultCount');
            let scannerActive = false;
            let searchTimeout = null;

            // Función para realizar búsqueda con debounce
            function performSearch() {
                const searchTerm = searchInput.value.trim();

                // Limpiar timeout anterior si existe
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Si el término está vacío, mostrar todos los productos
                if (searchTerm.length === 0) {
                    // Recargar la página para mostrar todos los productos
                    window.location.reload();
                    return;
                }

                // Establecer un nuevo timeout para evitar muchas solicitudes
                searchTimeout = setTimeout(() => {
                    fetch(`/Productos/Buscar?termino=${encodeURIComponent(searchTerm)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateProductTable(data.productos);
                                updateResultCount(data.productos.length);
                            } else {
                                showNoProductsMessage();
                                updateResultCount(0);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }, 300); // 300ms de retraso después de que el usuario deja de escribir
            }

            // Actualizar tabla con resultados de búsqueda
            function updateProductTable(productos) {
                productTableBody.innerHTML = '';

                if (productos.length === 0) {
                    showNoProductsMessage();
                    return;
                }

                productos.forEach(producto => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${producto.nombre}</td>
                        <td>${producto.precio}</td>
                        <td>${producto.stock}</td>
                        <td class="text-center">
                            <a href="/Productos/Edit/${producto.id}" class="btn btn-sm btn-outline-info rounded-pill me-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/Productos/Details/${producto.id}" class="btn btn-sm btn-outline-secondary rounded-pill me-1" title="Detalles">
                                <i class="fas fa-info-circle"></i>
                            </a>
                            <a href="/Productos/Delete/${producto.id}" class="btn btn-sm btn-outline-danger rounded-pill" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    `;
                    productTableBody.appendChild(row);
                });
            }

            // Actualizar contador de resultados
            function updateResultCount(count) {
                if (count === 0) {
                    resultCount.textContent = "No se encontraron resultados";
                } else if (count === 1) {
                    resultCount.textContent = "1 producto encontrado";
                } else {
                    resultCount.textContent = `${count} productos encontrados`;
                }
            }

            // Mostrar mensaje cuando no hay productos
            function showNoProductsMessage() {
                productTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle me-2"></i> No se encontraron productos que coincidan con su búsqueda.
                        </td>
                    </tr>
                `;
            }

            // Iniciar escáner de código de barras
            function startBarcodeScanner() {
                cameraContainer.classList.remove('d-none');

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner'),
                        constraints: {
                            width: 480,
                            height: 320,
                            facingMode: "environment" // Usar cámara trasera
                        }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                    }
                }, function(err) {
                    if (err) {
                        console.error(err);
                        alert('Error al iniciar la cámara: ' + err);
                        return;
                    }
                    scannerActive = true;
                    Quagga.start();
                });

                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    searchInput.value = code;
                    performSearch();
                    stopBarcodeScanner();
                });
            }

            // Detener escáner de código de barras
            function stopBarcodeScanner() {
                if (scannerActive) {
                    Quagga.stop();
                    scannerActive = false;
                }
                cameraContainer.classList.add('d-none');
            }

            // Event Listeners
            searchInput.addEventListener('input', performSearch);

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    // Cancelar el timeout y realizar búsqueda inmediata
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    performSearch();
                }
            });

            scanButton.addEventListener('click', startBarcodeScanner);

            closeCamera.addEventListener('click', stopBarcodeScanner);

            // Enfocar el campo de búsqueda al cargar la página
            searchInput.focus();
        });
    </script>
}